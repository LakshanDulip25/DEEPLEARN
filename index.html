<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="language" content="en">
    <title>Unit 5: Computer Operating System - Enhanced Dark Theme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Import Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Iskoola+Pota&display=swap');

        /* Base styles */
        body {
            font-family: 'Poppins', sans-serif;
            padding-bottom: 100px; /* Space for dashboard */
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #e5e7eb;
            transition: background 0.5s ease-in-out;
            overflow-x: hidden;
            margin: 0;
        }
        body.lang-si {
            font-family: 'Iskoola Pota', 'Poppins', sans-serif;
        }

        /* Matrix Canvas Styling */
        #matrix-canvas {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1; display: block; opacity: 0.15;
        }

        /* Main Container Enhancement */
        .main-container {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative; z-index: 1;
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
            border-radius: 1rem;
        }
        .main-container > * {
             position: relative;
             z-index: 1;
        }

        /* Content section visibility transition */
        .content-section {
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(15px);
            /* Define transition */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out; /* Keep transition */
        }
        .content-section.visible {
            display: block; /* Make visible */
            opacity: 1;
            transform: translateY(0);
        }


        /* Topic List Item Styling */
        .topic-list-item {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out, transform 0.3s ease-out;
            border-left-width: 4px; border-color: transparent;
            border-radius: 0.5rem; padding: 0.8rem 1rem; margin-bottom: 0.5rem;
            background: rgba(51, 65, 85, 0.5);
            opacity: 1; transform: scale(1); transform-origin: left;
        }
        .topic-list-item:hover {
            background: rgba(99, 102, 241, 0.25); border-color: #6366f1;
            transform: translateX(5px) scale(1.02); color: #ffffff; opacity: 1;
        }
        .topic-list-item.active {
            background-color: #4f46e5; border-color: #a5b4fc; color: white;
            font-weight: 600; transform: translateX(5px) scale(1);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4); opacity: 1;
        }
        .topic-list-item.active:hover {
            background-color: #5a55e8; border-color: #c7d2fe;
            transform: translateX(5px) scale(1.02);
        }
        .topic-list-item.inactive {
            opacity: 0.6; transform: scale(0.95);
            border-color: transparent !important; box-shadow: none;
        }
        .topic-list-item.inactive:hover {
            opacity: 0.8; transform: scale(0.97);
             background: rgba(51, 65, 85, 0.6); color: #cbd5e1;
        }

        /* Bottom Dashboard Styling */
        #bottom-dashboard {
            position: fixed;
            bottom: 1rem; left: 50%;
            transform: translateX(-50%);
            z-index: 100; width: auto;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 9999px;
            padding: 0.4rem 0.6rem;
            display: flex; justify-content: center; align-items: center; /* Center items */
            gap: 0.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; transform: translateX(-50%) translateY(120%);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            pointer-events: none;
        }
        #bottom-dashboard.visible {
            opacity: 1; transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        @media (min-width: 640px) { #bottom-dashboard { gap: 0.65rem; } }

        .dashboard-section { display: flex; align-items: center; gap: inherit; }

        /* Dashboard Button Styling */
        .dashboard-button {
             width: 2.25rem; height: 2.25rem; font-size: 1rem;
             border-radius: 50%; display: flex; align-items: center; justify-content: center;
             font-weight: normal; line-height: 1; color: #94a3b8;
             background-color: transparent; border: none; box-shadow: none;
             transition: all 0.2s ease-out; cursor: pointer; text-decoration: none;
             opacity: 0.8;
        }
        @media (min-width: 768px) {
            .dashboard-button { width: 2.5rem; height: 2.5rem; font-size: 1.1rem; }
             #home-btn { width: 3rem; height: 3rem; font-size: 1.3rem; }
        }
        .dashboard-button:hover {
             background-color: rgba(71, 85, 105, 0.3); color: #e5e7eb;
             transform: scale(1.1); opacity: 1;
        }
         .dashboard-button:active { transform: scale(0.95); background-color: rgba(99, 102, 241, 0.2); }
         #home-btn {
             background: linear-gradient(145deg, #4f46e5, #6366f1); color: white;
             box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); opacity: 1;
             margin-left: 0.5rem;
             margin-right: 0.5rem;
         }
         #home-btn:hover { background: linear-gradient(145deg, #6366f1, #4f46e5); box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4); transform: scale(1.05); }
         #translate-btn { font-weight: 600; font-size: 0.75rem; color: #94a3b8; width: 2.25rem; height: 2.25rem; }
          @media (min-width: 768px) { #translate-btn { font-size: 0.85rem; width: 2.5rem; height: 2.5rem; } }
         #translate-btn:hover { color: #e5e7eb; }
         /* Mute button icon size */
         #mute-btn i { font-size: 0.9rem; }
          @media (min-width: 768px) { #mute-btn i { font-size: 1rem; } }
          /* Login/Logout button styling */
         #login-modal-btn, #logout-btn {
             font-size: 0.75rem; /* Smaller text */
             width: auto !important; /* Allow button to size to content */
             height: auto !important;
             padding: 0.3rem 0.8rem; /* Adjust padding */
             border-radius: 0.375rem; /* Rounded corners */
         }


        /* Auth Modal Styling - Simplified for Google Sign In */
        #auth-modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #auth-modal-backdrop.visible { display: flex; align-items: center; justify-content: center; opacity: 1; }
        #auth-modal { background-color: #1f2937; border-radius: 0.75rem; padding: 2rem 2.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); width: 90%; max-width: 360px; border: 1px solid #4b5563; opacity: 0; transform: scale(0.95); transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; text-align: center; }
        #auth-modal-backdrop.visible #auth-modal { opacity: 1; transform: scale(1); }
        #auth-modal h3 { color: #e5e7eb; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;}
        #auth-error { color: #f87171; font-size: 0.875rem; margin-top: 1rem; min-height: 1.25rem; display: none; }
        #google-signin-btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.6rem 1.5rem; border-radius: 0.375rem; font-weight: 500;
            cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease;
            border: none; background-color: #4285F4; color: white; margin-bottom: 1rem;
        }
        #google-signin-btn:hover { background-color: #357ae8; }
        #google-signin-btn i { margin-right: 0.75rem; font-size: 1.1rem;}
        #auth-cancel-btn { background-color: #4b5563; color: #e5e7eb; width: 100%; padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; border: none; }
        #auth-cancel-btn:hover { background-color: #6b7280; }


        /* Summary Area Wrapper */
        .summary-wrapper { position: relative; margin-top: 1.5rem; }

        /* Icon size */
        .icon { width: 1.1rem; height: 1.1rem; display: inline-block; vertical-align: -0.15em; margin-right: 0.4rem; }

        /* Video Wrapper */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #111827; border-radius: 0.75rem; margin-top: 1rem; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3); }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; border-radius: 0.75rem; }

        /* Action Buttons - Updated Styles */
        .action-button { flex-grow: 1; text-align: center; justify-content: center; transition: all 0.25s ease-out; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2); padding: 0.6rem 1rem; color: #e5e7eb; border-radius: 0.5rem; font-weight: 500; font-size: 0.85rem; border: 1px solid rgba(96, 109, 128, 0.4); background: rgba(51, 65, 85, 0.5); }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); border-color: rgba(129, 140, 248, 0.5); background: rgba(71, 85, 105, 0.7); }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; background: rgba(51, 65, 85, 0.3); }
        /* Specific button overrides */
        a.action-button { background: linear-gradient(145deg, #14b8a6, #0d9488); border: none; color: white; } /* Teal for PDF */
        a.action-button:hover { background: linear-gradient(145deg, #0d9488, #047857); }
        button.edit-save-btn { background: linear-gradient(145deg, #6366f1, #4f46e5); border: none; color: white; } /* Indigo for Edit */
        button.edit-save-btn:hover { background: linear-gradient(145deg, #4f46e5, #4338ca); }
        button.edit-save-btn[data-key*="save_btn"] { background: linear-gradient(145deg, #22c55e, #10b981); } /* Green for Save */
        button.edit-save-btn[data-key*="save_btn"]:hover { background: linear-gradient(145deg, #10b981, #059669); }
        button.edit-video-btn { background: linear-gradient(145deg, #f97316, #ea580c); border: none; color: white; } /* Orange for Video */
        button.edit-video-btn:hover { background: linear-gradient(145deg, #ea580c, #c2410c); }
        button.edit-pdf-btn { background: linear-gradient(145deg, #0ea5e9, #0284c7); border: none; color: white; } /* Sky for PDF Link */
        button.edit-pdf-btn:hover { background: linear-gradient(145deg, #0284c7, #0369a1); }


        /* Action Buttons Container - Added Margin */
        .action-buttons-container { margin-top: 1.5rem; /* Add space above the buttons */ }

        /* Admin Button Styling - Hide by default */
        .admin-button {
            display: none;
        }
        /* Show admin buttons when body has .admin-logged-in class */
        body.admin-logged-in .admin-button {
            display: inline-flex;
        }


        #content-display-area { min-height: 300px; background: rgba(17, 24, 39, 0.6); border-radius: 1rem; }

        /* Styles for contentEditable and Toolbar */
        .summary-content { padding: 1rem; border: 1px solid transparent; border-radius: 0.5rem; min-height: 120px; background: rgba(55, 65, 81, 0.3); transition: border 0.3s ease, background-color 0.3s ease; line-height: 1.7; position: relative; }
        .summary-content[contenteditable="true"] { border: 1px solid #4b5563; min-height: 150px; background-color: #374151; color: #e5e7eb; outline: none; border-radius: 0 0 0.5rem 0.5rem; }
        .summary-content[contenteditable="true"]:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
        .editor-toolbar { display: none; background-color: #1f2937; padding: 0.6rem; border-radius: 0.5rem 0.5rem 0 0; border: 1px solid #4b5563; border-bottom: none; margin-bottom: 0px; flex-wrap: wrap; gap: 0.4rem; }
        /* Show toolbar only when logged in AND editing */
        body.admin-logged-in .summary-content[contenteditable="true"] ~ .action-buttons-container .editor-toolbar, /* Adjust selector if needed */
        body.admin-logged-in .summary-wrapper .editor-toolbar.visible {
             display: flex;
        }
        .editor-toolbar button, .editor-toolbar input[type="color"] { background-color: #4b5563; color: #e5e7eb; border: none; padding: 0.35rem 0.65rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.85rem; transition: background-color 0.2s ease, transform 0.1s ease; }
         .editor-toolbar button:hover { background-color: #525c6e; }
         .editor-toolbar button:active { transform: scale(0.95); }
         .editor-toolbar input[type="color"] { padding: 0.1rem 0.2rem; height: 1.8rem; width: 2.5rem; border: 1px solid #6b7280; border-radius: 0.375rem; }
         .editor-toolbar button svg { width: 1em; height: 1em; vertical-align: -0.125em; display: inline-block; }
         .summary-content ul, .summary-content ol { list-style-position: inside; padding-left: 1rem; margin: 0.75rem 0; }
         .summary-content li { margin-bottom: 0.4rem; line-height: 1.6; }
         .summary-content p { margin-bottom: 0.75rem; }

         /* Footer Styles */
         .app-footer { padding: 1.5rem 1rem; text-align: center; font-size: 0.8rem; color: #6b7280; width: 100%; }
         .app-footer a { color: #9ca3af; text-decoration: none; transition: color 0.2s ease; }
         .app-footer a:hover { color: #a5b4fc; text-decoration: underline; }

         /* Helper class to hide elements */
         .hidden { display: none; }

    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900 text-gray-300 min-h-screen p-4 md:p-8">

    <canvas id="matrix-canvas"></canvas>

    <div class="container mx-auto max-w-6xl main-container rounded-2xl p-6 md:p-10 relative">

        <div id="auth-status" class="absolute top-4 right-4 text-sm text-gray-400 flex items-center gap-3">
            <span id="user-email" class="hidden"></span>
            <button id="login-modal-btn" class="dashboard-button text-xs !w-auto !h-auto px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white">Login</button>
            <button id="logout-btn" class="dashboard-button text-xs !w-auto !h-auto px-3 py-1 bg-red-600 hover:bg-red-700 text-white hidden">Logout</button>
        </div>


        <header class="mb-8 text-center border-b border-gray-700/50 pb-6 pt-12"> <h1 id="main-title" data-key="main_title" class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-300 to-indigo-400 mb-2">Unit 5: Computer Operating System</h1>
            <p id="main-subtitle" data-key="main_subtitle" class="text-gray-400 mt-2 text-base md:text-lg">Using operating systems to manage the functionality of computers.</p>
        </header>

        <div class="flex flex-col md:flex-row md:gap-6 lg:gap-8">

            <aside id="topic-list-container" class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0 mb-8 md:mb-0 pr-4 md:pr-0">
                 <h2 class="text-xl font-semibold text-indigo-300 mb-4 hidden md:block">Topics (Unit 5)</h2>
                <nav id="topic-list" class="space-y-1">
                    <button data-target="topic-5-1" data-key="btn_5_1" class="topic-list-item w-full text-left">
                        5.1 Intro & Evolution
                    </button>
                    <button data-target="topic-5-2" data-key="btn_5_2" class="topic-list-item w-full text-left">
                        5.2 File Management
                    </button>
                    <button data-target="topic-5-3" data-key="btn_5_3" class="topic-list-item w-full text-left">
                        5.3 Process Management
                    </button>
                    <button data-target="topic-5-4" data-key="btn_5_4" class="topic-list-item w-full text-left">
                        5.4 Resource Management
                    </button>
                </nav>
            </aside>

            <main id="content-display-area" class="w-full md:w-2/3 lg:w-3/4 md:flex-grow p-6 rounded-xl border border-gray-700/30 shadow-lg">
                <div id="topic-5-1" class="content-section">
                    <h2 data-key="title_5_1" class="text-2xl font-semibold text-teal-300 mb-5">5.1 Intro & Evolution</h2>
                    <div class="pt-6 border-t border-gray-600/50">
                        <h3 data-key="video_title_5_1" class="text-lg font-semibold text-gray-200 mb-4">Watch Video</h3>
                        <div class="video-wrapper mb-6">
                            <iframe id="video-iframe-5-1" src="https://www.youtube.com/embed/placeholder_video_id_1_37" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        </div>
                    </div>
                    <div class="summary-wrapper">
                        <div id="toolbar-topic-5-1-summary" class="editor-toolbar"> <button data-command="bold" title="Bold"><b>B</b></button> <button data-command="italic" title="Italic"><i>I</i></button> <button data-command="underline" title="Underline"><u>U</u></button> <button data-command="justifyLeft" title="Align Left">L</button> <button data-command="justifyCenter" title="Align Center">C</button> <button data-command="justifyRight" title="Align Right">R</button> <button data-command="insertUnorderedList" title="Bullet List">• List</button> <button data-command="insertOrderedList" title="Numbered List">1. List</button> <button data-command="createLink" title="Link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757a4.5 4.5 0 016.364 0l1.757 1.757a.75.75 0 11-1.06 1.06l-1.757-1.757a3 3 0 00-4.243 0l-1.757 1.757a3 3 0 104.243 4.243l4.5-4.5a3 3 0 00-1.242-5.244zM12.75 8.688a.75.75 0 00-1.06 1.06l1.757 1.757a3 3 0 010 4.243l-1.757 1.757a.75.75 0 101.06 1.06l1.757-1.757a4.5 4.5 0 000-6.364l-1.757-1.757z" /></svg></button> <input type="color" data-command="foreColor" title="Text Color"> </div>
                        <div id="topic-5-1-summary" class="summary-content gradient-default prose prose-invert max-w-none text-gray-300"></div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 action-buttons-container">
                        <a href="#" target="_blank" data-key="pdf_link_text_5_1" id="pdf-link-5-1" class="action-button inline-flex items-center"> <svg class="icon fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/></svg> Download PDF </a>
                        <button data-summary-id="topic-5-1-summary" data-key="edit_btn_5_1" class="action-button edit-save-btn admin-button inline-flex items-center"> <svg class="icon fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"> <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /> <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /> </svg> Edit Summary </button>
                        <button data-target-iframe="video-iframe-5-1" data-key="edit_video_btn_5_1" class="action-button edit-video-btn admin-button inline-flex items-center"> <svg class="icon fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 2h6v4H7V5zm8 8H5v-2h10v2z" clip-rule="evenodd" /></svg> Set Video Link </button>
                        <button data-target-pdf="pdf-link-5-1" data-key="edit_pdf_btn_5_1" class="action-button edit-pdf-btn admin-button inline-flex items-center"> <svg class="icon fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" /></svg> Set PDF Link </button>
                    </div>
                 </div>
                <div id="topic-5-2" class="content-section">
                    <h2 data-key="title_5_2" class="text-2xl font-semibold text-teal-300 mb-5">5.2 File Management</h2>
                    <div class="pt-6 border-t border-gray-600/50"> <h3 data-key="video_title_5_2" class="text-lg font-semibold text-gray-200 mb-4">Watch Video</h3> <div class="video-wrapper mb-6"> <iframe id="video-iframe-5-2" src="https://www.youtube.com/embed/placeholder_video_id_1_38" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe> </div> </div>
                    <div class="summary-wrapper"> <div id="toolbar-topic-5-2-summary" class="editor-toolbar"> ... </div> <div id="topic-5-2-summary" class="summary-content gradient-default prose prose-invert max-w-none text-gray-300"></div> </div>
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 action-buttons-container"> <a href="#" target="_blank" data-key="pdf_link_text_5_2" id="pdf-link-5-2" class="action-button inline-flex items-center">...</a> <button data-summary-id="topic-5-2-summary" data-key="edit_btn_5_2" class="action-button edit-save-btn admin-button inline-flex items-center">...</button> <button data-target-iframe="video-iframe-5-2" data-key="edit_video_btn_5_2" class="action-button edit-video-btn admin-button inline-flex items-center">...</button> <button data-target-pdf="pdf-link-5-2" data-key="edit_pdf_btn_5_2" class="action-button edit-pdf-btn admin-button inline-flex items-center">...</button> </div>
                </div>
                 <div id="topic-5-3" class="content-section">
                    <h2 data-key="title_5_3" class="text-2xl font-semibold text-teal-300 mb-5">5.3 Process Management</h2>
                    <div class="pt-6 border-t border-gray-600/50"> <h3 data-key="video_title_5_3" class="text-lg font-semibold text-gray-200 mb-4">Watch Video</h3> <div class="video-wrapper mb-6"> <iframe id="video-iframe-5-3" src="https://www.youtube.com/embed/placeholder_video_id_1_39" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe> </div> </div>
                    <div class="summary-wrapper"> <div id="toolbar-topic-5-3-summary" class="editor-toolbar"> ... </div> <div id="topic-5-3-summary" class="summary-content gradient-default prose prose-invert max-w-none text-gray-300"></div> </div>
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 action-buttons-container"> <a href="#" target="_blank" data-key="pdf_link_text_5_3" id="pdf-link-5-3" class="action-button inline-flex items-center">...</a> <button data-summary-id="topic-5-3-summary" data-key="edit_btn_5_3" class="action-button edit-save-btn admin-button inline-flex items-center">...</button> <button data-target-iframe="video-iframe-5-3" data-key="edit_video_btn_5_3" class="action-button edit-video-btn admin-button inline-flex items-center">...</button> <button data-target-pdf="pdf-link-5-3" data-key="edit_pdf_btn_5_3" class="action-button edit-pdf-btn admin-button inline-flex items-center">...</button> </div>
                 </div>
                 <div id="topic-5-4" class="content-section">
                    <h2 data-key="title_5_4" class="text-2xl font-semibold text-teal-300 mb-5">5.4 Resource Management</h2>
                    <div class="pt-6 border-t border-gray-600/50"> <h3 data-key="video_title_5_4" class="text-lg font-semibold text-gray-200 mb-4">Watch Video</h3> <div class="video-wrapper mb-6"> <iframe id="video-iframe-5-4" src="https://www.youtube.com/embed/placeholder_video_id_1_40" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe> </div> </div>
                    <div class="summary-wrapper"> <div id="toolbar-topic-5-4-summary" class="editor-toolbar"> ... </div> <div id="topic-5-4-summary" class="summary-content gradient-default prose prose-invert max-w-none text-gray-300"></div> </div>
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 action-buttons-container"> <a href="#" target="_blank" data-key="pdf_link_text_5_4" id="pdf-link-5-4" class="action-button inline-flex items-center">...</a> <button data-summary-id="topic-5-4-summary" data-key="edit_btn_5_4" class="action-button edit-save-btn admin-button inline-flex items-center">...</button> <button data-target-iframe="video-iframe-5-4" data-key="edit_video_btn_5_4" class="action-button edit-video-btn admin-button inline-flex items-center">...</button> <button data-target-pdf="pdf-link-5-4" data-key="edit_pdf_btn_5_4" class="action-button edit-pdf-btn admin-button inline-flex items-center">...</button> </div>
                 </div>

                <div id="placeholder-content" class="text-center text-gray-500 pt-10">
                    <p data-key="placeholder_text">Select a topic from the list to view its content.</p>
                </div>
            </main>

        </div>

        <footer class="app-footer">
            <a href="https://t.me/MR_LXN" target="_blank" rel="noopener noreferrer">
                </> Developed by Lakshan 💻✨
            </a>
        </footer>

    </div>

    <div id="auth-modal-backdrop">
        <div id="auth-modal">
            <h3>Admin Login</h3>
            <div id="auth-error" class="text-red-500 text-sm mb-4 hidden"></div>
            <button id="google-signin-btn">
                 <i class="fab fa-google"></i> Sign in with Google
            </button>
             <button id="auth-cancel-btn">Cancel</button>
        </div>
    </div>


    <footer id="bottom-dashboard">
        <div class="dashboard-section"> <button id="translate-btn" data-lang="si" class="dashboard-button" aria-label="Translate">
                SI </button>
            <button id="fullscreen-btn" class="dashboard-button" aria-label="Toggle Fullscreen">
                <span id="fullscreen-enter-icon">↕️</span>
                <span id="fullscreen-exit-icon" class="hidden">🇽</span>
            </button>
            </div>
        <a href="index.html" id="home-btn" class="dashboard-button" aria-label="Home">
            🏠
        </a>
        <div class="dashboard-section"> <button id="mute-btn" class="dashboard-button" aria-label="Mute sound"> <i id="volume-icon" class="fas fa-volume-up"></i>
                <i id="mute-icon" class="fas fa-volume-mute hidden"></i>
            </button>
            <a href="https://t.me/MR_LXN" target="_blank" rel="noopener noreferrer" id="support-btn" class="dashboard-button" aria-label="Support">
                💬
            </a>
            <a href="donet.html" id="donate-btn" class="dashboard-button" aria-label="Donate">
                💖
            </a>
        </div>
    </footer>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAJg4Pu1qEsZTg2QRiGZQgU4z-2lw8-Wrk",
          authDomain: "deeplearnsl.firebaseapp.com",
          databaseURL: "https://deeplearnsl-default-rtdb.firebaseio.com",
          projectId: "deeplearnsl",
          storageBucket: "deeplearnsl.appspot.com",
          messagingSenderId: "372545200514",
          appId: "1:372545200514:web:29fe509e65ff575b2c2f9b"
        };

        // --- Initialize Firebase ---
        let database;
        let auth; // Firebase Auth instance
        try {
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            else { firebase.app(); }
            database = firebase.database();
            auth = firebase.auth(); // Initialize Auth
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Could not connect to the database. Editing features may not work.");
        }

        // --- Designated Admin Email ---
        const ADMIN_EMAIL = "lxn000000@gmail.com"; // <<< Your Admin Email Here

        // --- Translation Data for Unit 5 ---
        const translations = {
             en: {
                 main_title: "Unit 5: Computer Operating System", main_subtitle: "Using operating systems to manage the functionality of computers.",
                 btn_5_1: "5.1 Intro & Evolution", btn_5_2: "5.2 File Management", btn_5_3: "5.3 Process Management", btn_5_4: "5.4 Resource Management",
                 title_5_1: "5.1 Intro & Evolution", video_title_5_1: "Watch Video", pdf_link_text_5_1: "Download PDF", edit_btn_5_1: "Edit Summary", save_btn_5_1: "Save Summary", edit_video_btn_5_1: "Set Video Link", edit_pdf_btn_5_1: "Set PDF Link",
                 "topic-5-1-summary": `<p>Defines the computer operating system (OS) and investigates its need in computer systems.</p><ul><li>Evolution of OS.</li><li>Main functions: Providing interfaces, Process management, Resource management, Security and protection.</li><li>Classification: Single user-single task, Single user-multi task, Multi user-multi task, Multi-threading, Real time, Time sharing systems.</li></ul>`,
                 title_5_2: "5.2 File Management", video_title_5_2: "Watch Video", pdf_link_text_5_2: "Download PDF", edit_btn_5_2: "Edit Summary", save_btn_5_2: "Save Summary", edit_video_btn_5_2: "Set Video Link", edit_pdf_btn_5_2: "Set PDF Link",
                 "topic-5-2-summary": `<p>Explores how an operating system manages directories/folders and files.</p><ul><li>File types and their need (.exe, .jpg, .txt, etc.).</li><li>Directory and file organization: File hierarchy, File systems (FAT etc.).</li><li>File security: Passwords and access privileges.</li><li>File storage management: Contiguous, Linked, Indexed allocation.</li><li>Defragmentation.</li><li>Maintenance of secondary storage: Disk formatting.</li></ul>`,
                 title_5_3: "5.3 Process Management", video_title_5_3: "Watch Video", pdf_link_text_5_3: "Download PDF", edit_btn_5_3: "Edit Summary", save_btn_5_3: "Save Summary", edit_video_btn_5_3: "Set Video Link", edit_pdf_btn_5_3: "Set PDF Link",
                 "topic-5-3-summary": `<p>Explores how an operating system manages processes.</p><ul><li>Definition of a process.</li><li>Interrupts and interrupt handling.</li><li>Process states and transitions (using seven-state diagram).</li><li>Process Control Block (PCB).</li><li>Context switching.</li><li>Process schedulers (long, short, medium term) and scheduling policies.</li><li>Multiprogramming vs. Time sharing.</li><li>Turnaround time, response time, throughput time, waiting time.</li></ul>`,
                 title_5_4: "5.4 Resource Management", video_title_5_4: "Watch Video", pdf_link_text_5_4: "Download PDF", edit_btn_5_4: "Edit Summary", save_btn_5_4: "Save Summary", edit_video_btn_5_4: "Set Video Link", edit_pdf_btn_5_4: "Set PDF Link",
                 "topic-5-4-summary": `<p>Explores how an operating system manages resources like memory and I/O devices.</p><ul><li>Memory management: Memory Management Unit (MMU), Physical memory management, Virtual memory (paging, mapping).</li><li>Input/output device management: Device drivers, Spooling.</li></ul>`,
                 placeholder_text: "Select a topic from the list to view its content."
             },
             si: { /* Sinhala translations - Placeholders */
                 main_title: "ඒකකය 5: පරිගණක මෙහෙයුම් පද්ධති", main_subtitle: "පරිගණකවල ක්‍රියාකාරීත්වය කළමනාකරණය කිරීම සඳහා මෙහෙයුම් පද්ධති භාවිතා කිරීම.",
                 btn_5_1: "5.1 හැඳින්වීම සහ පරිණාමය", btn_5_2: "5.2 ගොනු කළමනාකරණය", btn_5_3: "5.3 ක්‍රියාවලි කළමනාකරණය", btn_5_4: "5.4 සම්පත් කළමනාකරණය",
                 title_5_1: "5.1 හැඳින්වීම සහ පරිණාමය", video_title_5_1: "වීඩියෝව නරඹන්න", pdf_link_text_5_1: "සාරාංශ PDF බාගන්න", edit_btn_5_1: "සාරාංශය සංස්කරණය කරන්න", save_btn_5_1: "සාරාංශය සුරකින්න", edit_video_btn_5_1: "වීඩියෝ සබැඳිය සකසන්න", edit_pdf_btn_5_1: "PDF සබැඳිය සකසන්න",
                 "topic-5-1-summary": `<p>පරිගණක මෙහෙයුම් පද්ධතිය (OS) අර්ථ දක්වන අතර පරිගණක පද්ධතිවල එහි අවශ්‍යතාවය විමර්ශනය කරයි.</p><ul><li>මෙහෙයුම් පද්ධති පරිණාමය.</li><li>ප්‍රධාන කාර්යයන්: අතුරුමුහුණත් සැපයීම, ක්‍රියාවලි කළමනාකරණය, සම්පත් කළමනාකරණය, ආරක්ෂාව සහ සුරැකීම.</li><li>වර්ගීකරණය: තනි පරිශීලක-තනි කාර්ය, තනි පරිශීලක-බහු කාර්ය, බහු පරිශීලක-බහු කාර්ය, බහු-නූල්කරණය, තත්‍ය කාලීන, කාලය බෙදාගැනීමේ පද්ධති.</li></ul>`,
                 title_5_2: "5.2 ගොනු කළමනාකරණය", video_title_5_2: "වීඩියෝව නරඹන්න", pdf_link_text_5_2: "සාරාංශ PDF බාගන්න", edit_btn_5_2: "සාරාංශය සංස්කරණය කරන්න", save_btn_5_2: "සාරාංශය සුරකින්න", edit_video_btn_5_2: "වීඩියෝ සබැඳිය සකසන්න", edit_pdf_btn_5_2: "PDF සබැඳිය සකසන්න",
                 "topic-5-2-summary": `<p>මෙහෙයුම් පද්ධතියක් නාමාවලි/ෆෝල්ඩර සහ ගොනු කළමනාකරණය කරන ආකාරය ගවේෂණය කරයි.</p><ul><li>ගොනු වර්ග සහ ඒවායේ අවශ්‍යතාවය (.exe, .jpg, .txt, etc.).</li><li>නාමාවලි සහ ගොනු සංවිධානය: ගොනු ධුරාවලිය, ගොනු පද්ධති (FAT etc.).</li><li>ගොනු ආරක්ෂාව: මුරපද සහ ප්‍රවේශ වරප්‍රසාද.</li><li>ගොනු ගබඩා කළමනාකරණය: සන්තතික, සම්බන්ධිත, සුචිගත වෙන් කිරීම.</li><li>විඛණ්ඩනය ඉවත් කිරීම (Defragmentation).</li><li>ද්විතීයික ආචයන නඩත්තුව: තැටි ආකෘතිකරණය (Disk formatting).</li></ul>`,
                 title_5_3: "5.3 ක්‍රියාවලි කළමනාකරණය", video_title_5_3: "වීඩියෝව නරඹන්න", pdf_link_text_5_3: "සාරාංශ PDF බාගන්න", edit_btn_5_3: "සාරාංශය සංස්කරණය කරන්න", save_btn_5_3: "සාරාංශය සුරකින්න", edit_video_btn_5_3: "වීඩියෝ සබැඳිය සකසන්න", edit_pdf_btn_5_3: "PDF සබැඳිය සකසන්න",
                 "topic-5-3-summary": `<p>මෙහෙයුම් පද්ධතියක් ක්‍රියාවලි කළමනාකරණය කරන ආකාරය ගවේෂණය කරයි.</p><ul><li>ක්‍රියාවලියක අර්ථ දැක්වීම.</li><li>බාධා කිරීම් සහ බාධා හැසිරවීම.</li><li>ක්‍රියාවලි අවස්ථා සහ සංක්‍රාන්ති (සත්-අවස්ථා රූප සටහන භාවිතයෙන්).</li><li>ක්‍රියාවලි පාලන කොටස (PCB).</li><li>සන්දර්භ මාරු කිරීම (Context switching).</li><li>ක්‍රියාවලි උපලේඛනගත කරන්නන් (දිගු, කෙටි, මධ්‍ය කාලීන) සහ උපලේඛනගත කිරීමේ ප්‍රතිපත්ති.</li><li>බහු ක්‍රමලේඛනය එදිරිව කාලය බෙදාගැනීම.</li><li>හැරවුම් කාලය, ප්‍රතිචාර කාලය, ප්‍රතිදාන කාලය, රැඳී සිටීමේ කාලය.</li></ul>`,
                 title_5_4: "5.4 සම්පත් කළමනාකරණය", video_title_5_4: "වීඩියෝව නරඹන්න", pdf_link_text_5_4: "සාරාංශ PDF බාගන්න", edit_btn_5_4: "සාරාංශය සංස්කරණය කරන්න", save_btn_5_4: "සාරාංශය සුරකින්න", edit_video_btn_5_4: "වීඩියෝ සබැඳිය සකසන්න", edit_pdf_btn_5_4: "PDF සබැඳිය සකසන්න",
                 "topic-5-4-summary": `<p>මෙහෙයුම් පද්ධතියක් මතකය සහ ආදාන/ප්‍රතිදාන උපාංග වැනි සම්පත් කළමනාකරණය කරන ආකාරය ගවේෂණය කරයි.</p><ul><li>මතක කළමනාකරණය: මතක කළමනාකරණ ඒකකය (MMU), භෞතික මතක කළමනාකරණය, අතාත්වික මතකය (පිටුකරණය, සිතියම්ගත කිරීම).</li><li>ආදාන/ප්‍රතිදාන උපාංග කළමනාකරණය: උපාංග ධාවක (Device drivers), ස්පූල් කිරීම (Spooling).</li></ul>`,
                 placeholder_text: "අන්තර්ගතය බැලීමට ලැයිස්තුවෙන් මාතෘකාවක් තෝරන්න."
             }
         };


        // --- UI Elements ---
        const topicListContainer = document.getElementById('topic-list');
        const contentDisplayArea = document.getElementById('content-display-area');
        const contentSections = contentDisplayArea.querySelectorAll('.content-section');
        const topicListItems = topicListContainer.querySelectorAll('.topic-list-item');
        const placeholderContent = document.getElementById('placeholder-content');
        const bottomDashboard = document.getElementById('bottom-dashboard');
        const translateButton = document.getElementById('translate-btn');
        const fullscreenButton = document.getElementById('fullscreen-btn');
        const fullscreenEnterIcon = document.getElementById('fullscreen-enter-icon');
        const fullscreenExitIcon = document.getElementById('fullscreen-exit-icon');
        const muteButton = document.getElementById('mute-btn');
        const volumeIcon = document.getElementById('volume-icon');
        const muteIcon = document.getElementById('mute-icon');
        const supportButton = document.getElementById('support-btn');
        const donateButton = document.getElementById('donate-btn');
        const homeButton = document.getElementById('home-btn');
        const translatableElements = document.querySelectorAll('[data-key]');
        const bodyElement = document.body;
        // Auth UI Elements
        const authStatusDiv = document.getElementById('auth-status');
        const userEmailSpan = document.getElementById('user-email');
        const loginModalButton = document.getElementById('login-modal-btn');
        const logoutButton = document.getElementById('logout-btn');
        const authModalBackdrop = document.getElementById('auth-modal-backdrop');
        const authModal = document.getElementById('auth-modal');
        const googleSignInButton = document.getElementById('google-signin-btn'); // Google Button
        const authCancelButton = document.getElementById('auth-cancel-btn');
        const authErrorDiv = document.getElementById('auth-error');

        // --- State ---
        let isMuted = false; // Mute state for click sound

        // --- Tone.js Sound Setup ---
        let clickSound = null;
        function initializeAudio() {
            if (!clickSound && typeof Tone !== 'undefined' && Tone.MembraneSynth) {
                 clickSound = new Tone.MembraneSynth({
                    pitchDecay: 0.008,
                    octaves: 2,
                    envelope: { attack: 0.0006, decay: 0.5, sustain: 0 }
                 }).toDestination();
                 console.log("Tone.js click sound initialized.");
                 if (Tone.context.state !== 'running') {
                    Tone.start().then(() => console.log("Audio context started."));
                 }
            } else if (!clickSound) {
                console.warn("Tone.js not fully loaded yet or MembraneSynth unavailable.");
            }
        }

        function playButtonClickSound() {
            if (!isMuted && clickSound) {
                try {
                    if (Tone.context.state !== 'running') {
                        Tone.start().then(() => {
                             clickSound.triggerAttackRelease("C2", "8n", Tone.now());
                        });
                    } else {
                        clickSound.triggerAttackRelease("C2", "8n", Tone.now());
                    }
                } catch (error) {
                    console.error("Error playing sound:", error);
                    clickSound = null;
                }
            } else if (!isMuted) {
                initializeAudio();
                 if (clickSound) {
                     try {
                         if (Tone.context.state !== 'running') {
                             Tone.start().then(() => {
                                 clickSound.triggerAttackRelease("C2", "8n", Tone.now());
                             });
                         } else {
                             clickSound.triggerAttackRelease("C2", "8n", Tone.now());
                         }
                     } catch (error) {
                         console.error("Error playing sound after init:", error);
                     }
                 }
            }
        }

        // --- Function to Load Summary from Firebase ---
        function loadSummary(summaryId, targetLang) {
            const summaryDiv = document.getElementById(summaryId);
            if (!summaryDiv || !database) return Promise.resolve();
            const defaultHTML = translations[targetLang]?.[summaryId] || `<p class="text-gray-400 italic">Default content not found for ${summaryId} [${targetLang}].</p>`;
            const dbPath = `summaries/${targetLang}/${summaryId}`;
            const summaryRef = database.ref(dbPath);
            return summaryRef.once('value')
                .then((snapshot) => {
                    const summaryHTML = snapshot.val();
                    summaryDiv.innerHTML = (summaryHTML !== null && summaryHTML !== undefined) ? summaryHTML : defaultHTML;
                })
                .catch((error) => {
                    console.error(`Error loading summary for ${dbPath}: `, error);
                    summaryDiv.innerHTML = defaultHTML;
                    return Promise.reject(error);
                });
        }

        // --- Function to Load Link from Firebase ---
        function loadLink(targetElementId, linkType, targetLang) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement || !database) return Promise.resolve();

            const defaultUrl = (linkType === 'video' && targetElement.tagName === 'IFRAME') ? targetElement.getAttribute('src') :
                               (linkType === 'pdf' && targetElement.tagName === 'A') ? targetElement.getAttribute('href') : '#';

            const dbPath = `links/${targetLang}/${targetElementId}`;
            const linkRef = database.ref(dbPath);

            return linkRef.once('value')
                .then((snapshot) => {
                    const savedUrl = snapshot.val();
                    const finalUrl = (savedUrl !== null && savedUrl !== undefined && savedUrl.trim() !== "") ? savedUrl : defaultUrl;

                    if (linkType === 'video' && targetElement.tagName === 'IFRAME') {
                        if (targetElement.src !== finalUrl) {
                           targetElement.src = finalUrl;
                           console.log(`Video link updated for ${targetElementId} from DB.`);
                        }
                    } else if (linkType === 'pdf' && targetElement.tagName === 'A') {
                         if (targetElement.href !== finalUrl) {
                            targetElement.href = finalUrl;
                            console.log(`PDF link updated for ${targetElementId} from DB.`);
                         }
                    }
                })
                .catch((error) => {
                    if (error.code !== 'PERMISSION_DENIED') {
                         console.error(`Error loading link for ${dbPath}: `, error);
                         alert(`Error loading ${linkType} link. See console.`);
                    } else {
                         console.warn(`Permission denied loading link for ${dbPath}. Using default.`);
                    }
                    if (linkType === 'video' && targetElement.tagName === 'IFRAME') {
                        targetElement.src = defaultUrl;
                    } else if (linkType === 'pdf' && targetElement.tagName === 'A') {
                        targetElement.href = defaultUrl;
                    }
                    return Promise.reject(error);
                });
        }


        // --- Function to execute formatting commands ---
        function formatDoc(command, value = null) {
            const visibleSection = contentDisplayArea.querySelector('.content-section.visible');
            if (!visibleSection) return;
            const activeEditor = visibleSection.querySelector('.summary-content[contenteditable="true"]');
            if (!activeEditor) return;

            activeEditor.focus();

            if (command === 'createLink') {
                 let url = prompt("Enter the link URL:", "http://");
                 if (url && url !== "" && url !== "http://") {
                     document.execCommand(command, false, url);
                 }
             } else if (command === 'foreColor') {
                  document.execCommand(command, false, value);
             } else {
                 document.execCommand(command, false, null);
             }
            activeEditor.focus();
         }

        // --- Function to make summary editable ---
        function makeEditable(summaryDiv, toolbar) {
            summaryDiv.setAttribute('contentEditable', 'true');
            toolbar.classList.add('visible');
            summaryDiv.focus();
            console.log("Made editable:", summaryDiv.id);
        }
        // --- Function to make summary non-editable ---
        function makeNonEditable(summaryDiv, toolbar) {
            summaryDiv.removeAttribute('contentEditable');
            toolbar.classList.remove('visible');
            console.log("Made non-editable:", summaryDiv.id);
        }

        // --- Function to Prompt for and Update Link (with Firebase Save) ---
        function promptForLink(targetElementId, linkType) {
            let promptMessage = "";
            if (linkType === 'video') {
                promptMessage = "Enter new YouTube EMBED URL (e.g., https://www.youtube.com/embed/VIDEO_ID):";
            } else {
                promptMessage = "Enter new PDF URL:";
            }

            const currentElement = document.getElementById(targetElementId);
            const currentUrl = (linkType === 'video') ? currentElement?.src : currentElement?.href;

            const newUrl = prompt(promptMessage, currentUrl || "");
            const currentLang = document.body.classList.contains('lang-si') ? 'si' : 'en';

            if (newUrl === null) return;

            if (newUrl.trim() !== "") {
                if (linkType === 'video' && !newUrl.includes('youtube.com/embed/')) {
                    alert("Invalid YouTube Embed URL format. Please use the format: https://www.youtube.com/embed/VIDEO_ID");
                    return;
                }

                const targetElement = document.getElementById(targetElementId);
                if (targetElement) {
                    if (linkType === 'video' && targetElement.tagName === 'IFRAME') {
                        targetElement.src = newUrl;
                    } else if (linkType === 'pdf' && targetElement.tagName === 'A') {
                        targetElement.href = newUrl;
                    } else {
                        console.error(`Invalid target element or link type for ID: ${targetElementId}`);
                        return;
                    }

                    const dbPath = `links/${currentLang}/${targetElementId}`;
                    const linkRef = database.ref(dbPath);
                    linkRef.set(newUrl)
                        .then(() => {
                            console.log(`${linkType} link saved successfully to Firebase at ${dbPath}`);
                            alert(`${linkType === 'video' ? 'Video' : 'PDF'} link updated successfully!`);
                        })
                        .catch((error) => {
                            console.error(`Error saving ${linkType} link to Firebase at ${dbPath}: `, error);
                            alert(`Error saving ${linkType === 'video' ? 'Video' : 'PDF'} link. Check console.`);
                            if (linkType === 'video') targetElement.src = currentUrl;
                            else if (linkType === 'pdf') targetElement.href = currentUrl;
                        });

                } else {
                    console.error(`Target element not found for ID: ${targetElementId}`);
                }
            } else {
                alert("URL cannot be empty.");
            }
        }

        // --- Event Listener for Topic Selection (with Smooth Transitions) ---
        topicListContainer.addEventListener('click', function(event) {
            const button = event.target.closest('.topic-list-item');
            if (!button) return;

            const targetId = button.getAttribute('data-target');
            const targetContent = document.getElementById(targetId);
            const currentLang = document.body.classList.contains('lang-si') ? 'si' : 'en';
            const currentlyVisible = contentDisplayArea.querySelector('.content-section.visible');

            if (currentlyVisible === targetContent) return;

            topicListItems.forEach(item => {
                item.classList.toggle('active', item === button);
                item.classList.toggle('inactive', item !== button);
            });

            const showNewTopic = () => {
                if (placeholderContent) placeholderContent.style.display = 'none';
                if (targetContent) {
                    const summaryId = targetId + '-summary';
                    const videoIframeId = `video-iframe-${targetId.split('-')[1]}-${targetId.split('-')[2]}`;
                    const pdfLinkId = `pdf-link-${targetId.split('-')[1]}-${targetId.split('-')[2]}`;

                    Promise.allSettled([
                        loadSummary(summaryId, currentLang),
                        loadLink(videoIframeId, 'video', currentLang),
                        loadLink(pdfLinkId, 'pdf', currentLang)
                    ]).finally(() => {
                            targetContent.style.display = 'block';
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    targetContent.classList.add('visible');
                                    setLanguage(currentLang, false);
                                });
                            });
                        });
                } else {
                    if (placeholderContent) placeholderContent.style.display = 'block';
                }
            };

            if (currentlyVisible) {
                 const currentSummaryId = currentlyVisible.id + '-summary';
                 const currentSummaryDiv = document.getElementById(currentSummaryId);
                 const currentToolbar = document.getElementById(`toolbar-${currentSummaryId}`);
                 const editButton = currentlyVisible.querySelector('.edit-save-btn');
                 if (currentSummaryDiv && currentToolbar && currentSummaryDiv.getAttribute('contentEditable') === 'true') {
                     makeNonEditable(currentSummaryDiv, currentToolbar);
                     if (editButton && editButton.getAttribute('data-key').startsWith('save_btn')) {
                         const editKey = editButton.getAttribute('data-key').replace('save', 'edit');
                         editButton.setAttribute('data-key', editKey);
                         editButton.disabled = false;
                     }
                 }
                 const iframe = currentlyVisible.querySelector('iframe');
                 if (iframe && iframe.contentWindow) { try { iframe.contentWindow.postMessage('{"event":"command","func":"stopVideo","args":""}', '*'); } catch(e) { console.warn("Could not stop video in iframe:", e); } }

                currentlyVisible.classList.remove('visible');

                currentlyVisible.addEventListener('transitionend', function handler(e) {
                    if (e.propertyName === 'opacity') {
                        currentlyVisible.style.display = 'none';
                        currentlyVisible.removeEventListener('transitionend', handler);
                        showNewTopic();
                    }
                }, { once: false });

            } else {
                showNewTopic();
            }
        });


        // --- Edit/Save/Link Button Logic (Now requires Auth) ---
        function handleAdminAction(button) {
            if (!auth || !auth.currentUser) {
                alert("Please log in as admin to perform this action.");
                showAuthModal();
                return;
            }
             // Check if the logged-in user is the designated admin
            if (auth.currentUser.email !== ADMIN_EMAIL) {
                alert("You are not authorized to perform this action.");
                return;
            }

            // If logged in AND authorized, proceed
            if (button.classList.contains('edit-save-btn')) {
                const summaryId = button.dataset.summaryId;
                const summaryDiv = document.getElementById(summaryId);
                const toolbar = document.getElementById(`toolbar-${summaryId}`);
                const isEditing = summaryDiv.getAttribute('contentEditable') === 'true';
                const currentLang = document.body.classList.contains('lang-si') ? 'si' : 'en';

                if (isEditing) { // Save action
                    const editedContent = summaryDiv.innerHTML;
                    makeNonEditable(summaryDiv, toolbar);
                    const dbPath = `summaries/${currentLang}/${summaryId}`;
                    const summaryRef = database.ref(dbPath);
                    button.disabled = true;
                    const iconSVG = button.querySelector('svg.icon');
                    button.textContent = 'Saving...';
                    if(iconSVG) button.prepend(iconSVG.cloneNode(true));
                    summaryRef.set(editedContent)
                        .then(() => {
                            console.log(`Summary saved successfully to Firebase at ${dbPath}`);
                            button.disabled = false;
                            const editKey = button.getAttribute('data-key').replace('save', 'edit');
                            button.setAttribute('data-key', editKey);
                            setLanguage(currentLang, false);
                        })
                        .catch((error) => {
                            console.error(`Error saving summary to Firebase at ${dbPath}: `, error);
                            alert("Error saving summary. Ensure you are logged in and have write permissions.");
                            button.disabled = false;
                            const saveKey = button.getAttribute('data-key');
                            setLanguage(currentLang, false);
                        });
                } else { // Edit action
                    makeEditable(summaryDiv, toolbar);
                    const saveKey = button.getAttribute('data-key').replace('edit', 'save');
                    button.setAttribute('data-key', saveKey);
                    setLanguage(currentLang, false);
                }

            } else if (button.classList.contains('edit-video-btn')) {
                const iframeId = button.dataset.targetIframe;
                if (iframeId) promptForLink(iframeId, 'video');
            } else if (button.classList.contains('edit-pdf-btn')) {
                const linkId = button.dataset.targetPdf;
                if (linkId) promptForLink(linkId, 'pdf');
            }
        }


        // --- Translation Logic ---
        function setLanguage(lang, reloadSummary = true) {
            console.log(`Setting language to: ${lang}. Reload summary: ${reloadSummary}`);
            const activeTopicButton = topicListContainer.querySelector('.topic-list-item.active');
            const currentVisibleSection = contentDisplayArea.querySelector('.content-section.visible');

            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                const isSummaryContent = element.classList.contains('summary-content');
                const parentSummaryDiv = element.closest('div[id$="-summary"]');
                const isBeingEdited = parentSummaryDiv && parentSummaryDiv.getAttribute('contentEditable') === 'true';

                if (translations[lang]?.[key] && !isSummaryContent && !isBeingEdited) {
                     const iconSVG = element.querySelector('svg.icon');
                     let translatedText = translations[lang][key];
                     if ((element.tagName === 'BUTTON' || element.tagName === 'A') && iconSVG && element.classList.contains('action-button')) {
                         element.textContent = translatedText; element.prepend(iconSVG); element.classList.add('inline-flex', 'items-center');
                     }
                     // Handle edit/save/link buttons specifically
                     else if (element.tagName === 'BUTTON' && (element.classList.contains('edit-save-btn') || element.classList.contains('edit-video-btn') || element.classList.contains('edit-pdf-btn'))) {
                         const currentIcon = element.querySelector('svg.icon');
                         element.textContent = translatedText;
                         if (currentIcon) element.prepend(currentIcon);
                         element.classList.add('inline-flex', 'items-center');
                     }
                     else if (element.id === 'main-title' || element.id === 'main-subtitle' || element.classList.contains('topic-list-item') || element.tagName === 'H2' || element.tagName === 'H3' || element.id === 'placeholder-content') {
                         element.textContent = translatedText;
                     }
                     else { element.textContent = translatedText; }
                } else if (isBeingEdited) {
                     // Only update save button text if editing
                     if (element.tagName === 'BUTTON' && element.classList.contains('edit-save-btn') && element.getAttribute('data-key').startsWith('save_btn_')) {
                         const currentIcon = element.querySelector('svg.icon');
                         element.textContent = translations[lang][key];
                         if (currentIcon) element.prepend(currentIcon);
                         element.classList.add('inline-flex', 'items-center');
                     }
                }
            });

            const nextLangCode = lang === 'en' ? 'SI' : 'EN';
            translateButton.textContent = nextLangCode;
            bodyElement.classList.remove('lang-en', 'lang-si');
            bodyElement.classList.add(`lang-${lang}`);
            translateButton.setAttribute('data-lang', lang === 'en' ? 'si' : 'en');

            if (currentVisibleSection && reloadSummary) {
                const summaryId = currentVisibleSection.id + '-summary';
                const videoIframeId = currentVisibleSection.querySelector('iframe')?.id;
                const pdfLinkId = currentVisibleSection.querySelector('a[id^="pdf-link-"]')?.id;
                const summaryDiv = document.getElementById(summaryId);
                const toolbar = document.getElementById(`toolbar-${summaryId}`);
                if (summaryDiv && toolbar && summaryDiv.getAttribute('contentEditable') === 'true') {
                    makeNonEditable(summaryDiv, toolbar);
                     const editButton = currentVisibleSection.querySelector('.edit-save-btn');
                     if(editButton) {
                         const editKey = editButton.getAttribute('data-key').startsWith('save_') ? editButton.getAttribute('data-key').replace('save', 'edit') : editButton.getAttribute('data-key');
                         editButton.setAttribute('data-key', editKey);
                         editButton.disabled = false;
                         // No need to call setLanguage again here, it's done below
                     }
                }
                // Load summary and links for the new language
                Promise.allSettled([ // Use allSettled
                    loadSummary(summaryId, lang),
                    videoIframeId ? loadLink(videoIframeId, 'video', lang) : Promise.resolve(),
                    pdfLinkId ? loadLink(pdfLinkId, 'pdf', lang) : Promise.resolve()
                ]).finally(() => {
                    setLanguage(lang, false); // Update static text after all loads complete
                });
            } else if (currentVisibleSection) { // Update static text if not reloading summary
                 currentVisibleSection.querySelectorAll('[data-key]:not(.summary-content)').forEach(el => {
                     const key = el.getAttribute('data-key');
                     if (translations[lang]?.[key]) {
                         if (el.tagName === 'H2' || el.tagName === 'H3') {
                            el.textContent = translations[lang][key];
                         } else if (el.classList.contains('action-button')) {
                            const iconSVG = el.querySelector('svg.icon');
                            el.textContent = translations[lang][key];
                            if (iconSVG) el.prepend(iconSVG);
                            el.classList.add('inline-flex', 'items-center');
                         }
                     }
                 });
            }

             if (activeTopicButton) {
                 topicListItems.forEach(item => {
                     item.classList.toggle('active', item === activeTopicButton);
                     item.classList.toggle('inactive', item !== activeTopicButton);
                 });
             }
        }

        // --- Translate Button Event Listener ---
        translateButton.addEventListener('click', () => {
            const targetLang = translateButton.getAttribute('data-lang');
            console.log("Translate button clicked. Target language:", targetLang);
            setLanguage(targetLang, true);
        });

        // --- Fullscreen Toggle Logic ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        function updateFullscreenButtonIcon() {
            if (document.fullscreenElement) {
                fullscreenEnterIcon.style.display = 'none';
                fullscreenExitIcon.style.display = 'inline';
            } else {
                fullscreenEnterIcon.style.display = 'inline';
                fullscreenExitIcon.style.display = 'none';
            }
        }

        fullscreenButton.addEventListener('click', toggleFullScreen);
        document.addEventListener('fullscreenchange', updateFullscreenButtonIcon);

        // --- Mute Button Logic (for click sound) ---
        muteButton.addEventListener('click', () => {
            isMuted = !isMuted; // Toggle mute state for click sound
            volumeIcon.classList.toggle('hidden', isMuted);
            muteIcon.classList.toggle('hidden', !isMuted);
            muteButton.setAttribute('aria-label', isMuted ? 'Unmute sound' : 'Mute sound');
            if (!isMuted) {
                 playButtonClickSound();
            }
        });

        // --- Auto-Hide Dashboard Logic ---
        let dashboardTimeout;
        let lastScrollTop = 0;
        const dashboardHideDelay = 6000;
        const scrollThreshold = 10;

        function showDashboard() {
            bottomDashboard.classList.add('visible');
            clearTimeout(dashboardTimeout);
            dashboardTimeout = setTimeout(() => {
                if (!bottomDashboard.matches(':hover')) {
                     bottomDashboard.classList.remove('visible');
                }
            }, dashboardHideDelay);
        }

        function hideDashboard() {
            clearTimeout(dashboardTimeout);
            bottomDashboard.classList.remove('visible');
        }

        // Show dashboard initially
        showDashboard();

        // Handle scroll direction
        window.addEventListener('scroll', () => {
            let currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (Math.abs(currentScrollTop - lastScrollTop) <= scrollThreshold) return;
            if (currentScrollTop > lastScrollTop) hideDashboard();
            else showDashboard();
            lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
        }, { passive: true });

        // Reset timer and show dashboard on other interactions
        ['mousemove', 'touchstart'].forEach(eventType => {
            window.addEventListener(eventType, showDashboard, { passive: true });
        });

        // Keep dashboard visible while hovering over it
        bottomDashboard.addEventListener('mouseenter', () => clearTimeout(dashboardTimeout));
        bottomDashboard.addEventListener('mouseleave', () => { if (bottomDashboard.classList.contains('visible')) showDashboard(); });


        // --- Matrix Background Effect ---
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        let matrixInterval;

        function setupMatrix() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const columns = canvas.width / font_size;
            drops = [];
            for (let x = 0; x < columns; x++) drops[x] = 1;
        }

        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890@#$%^&*()*&^%+-=/".split('');
        const font_size = 12;
        let drops = [];

        function drawMatrix() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.04)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "rgba(229, 231, 235, 0.8)";
            ctx.font = font_size + "px monospace";
            for (let i = 0; i < drops.length; i++) {
                const text = chars[Math.floor(Math.random() * chars.length)];
                ctx.fillText(text, i * font_size, drops[i] * font_size);
                if (drops[i] * font_size > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        }

        function startMatrix() {
            setupMatrix();
            if (matrixInterval) clearInterval(matrixInterval);
            matrixInterval = setInterval(drawMatrix, 50);
        }

        window.addEventListener('resize', setupMatrix);

        // --- Authentication Logic ---
        function showAuthModal() { authModalBackdrop.classList.add('visible'); }
        function hideAuthModal() { authModalBackdrop.classList.remove('visible'); authErrorDiv.style.display = 'none'; }

        loginModalButton.addEventListener('click', showAuthModal);
        authCancelButton.addEventListener('click', hideAuthModal);
        authModalBackdrop.addEventListener('click', (e) => { if (e.target === authModalBackdrop) hideAuthModal(); });

        // Google Sign In
        googleSignInButton.addEventListener('click', () => {
            authErrorDiv.style.display = 'none'; // Hide previous errors
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    // const credential = result.credential;
                    // const token = credential.accessToken;
                    // The signed-in user info.
                    const user = result.user;
                    console.log("Google Sign-in successful:", user.email);
                    hideAuthModal();
                    // Auth state change will handle UI updates
                }).catch((error) => {
                    // Handle Errors here.
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    // The email of the user's account used.
                    const email = error.email;
                    // The firebase.auth.AuthCredential type that was used.
                    const credential = error.credential;
                    console.error("Google Sign-in Error:", errorCode, errorMessage, email, credential);
                    authErrorDiv.textContent = errorMessage;
                    authErrorDiv.style.display = 'block';
                });
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log("Logout successful");
                 // Auth state change will handle UI updates
            }).catch((error) => {
                console.error("Logout Error:", error);
                alert("Error logging out.");
            });
        });

        // Auth State Change Listener
        auth.onAuthStateChanged((user) => {
            if (user && user.email === ADMIN_EMAIL) { // Check if user exists AND email matches admin
                // User is the designated Admin
                console.log("Admin logged in:", user.email);
                bodyElement.classList.add('admin-logged-in'); // Add class to show admin buttons
                loginModalButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                userEmailSpan.textContent = user.email;
                userEmailSpan.classList.remove('hidden');

            } else {
                // User is signed out OR is not the designated admin
                if (user) {
                    console.log("Logged in user is not admin:", user.email);
                    // Optionally log out non-admin users immediately
                    // auth.signOut();
                } else {
                    console.log("User logged out");
                }
                bodyElement.classList.remove('admin-logged-in'); // Remove class to hide admin buttons
                loginModalButton.classList.remove('hidden');
                logoutButton.classList.add('hidden');
                userEmailSpan.textContent = '';
                userEmailSpan.classList.add('hidden');

                // If user logs out (or is not admin) while editing, revert the edit state
                const currentlyVisible = contentDisplayArea.querySelector('.content-section.visible');
                if (currentlyVisible) {
                     const currentSummaryId = currentlyVisible.id + '-summary';
                     const currentSummaryDiv = document.getElementById(currentSummaryId);
                     const currentToolbar = document.getElementById(`toolbar-${currentSummaryId}`);
                     const editButton = currentlyVisible.querySelector('.edit-save-btn');
                     if (currentSummaryDiv && currentToolbar && currentSummaryDiv.getAttribute('contentEditable') === 'true') {
                         makeNonEditable(currentSummaryDiv, currentToolbar);
                         if (editButton && editButton.getAttribute('data-key').startsWith('save_btn')) {
                             const editKey = editButton.getAttribute('data-key').replace('save', 'edit');
                             editButton.setAttribute('data-key', editKey);
                             editButton.disabled = false;
                             // Reload summary to discard unsaved changes
                             const currentLang = document.body.classList.contains('lang-si') ? 'si' : 'en';
                             loadSummary(currentSummaryId, currentLang);
                         }
                     }
                }
            }
        });


        // --- Enhanced Event Delegation for Editor Toolbar & Button Sounds ---
        document.body.addEventListener('click', function(event) {
            const target = event.target;
            const targetButton = target.closest('button'); // Find closest button

            // Play sound for relevant button clicks (excluding mute itself)
            if (targetButton && targetButton.id !== 'mute-btn' && (
                targetButton.classList.contains('topic-list-item') ||
                targetButton.classList.contains('action-button') ||
                targetButton.classList.contains('dashboard-button') ||
                targetButton.classList.contains('modal-button') || // Added modal buttons
                targetButton.closest('.editor-toolbar')
            )) {
                playButtonClickSound();
            }

            // --- Editor Toolbar Button Click ---
            if (targetButton && targetButton.closest('.editor-toolbar')) {
                 const command = targetButton.dataset.command;
                 if (command) {
                     formatDoc(command);
                 }
            }
            // --- Admin Action Button Click ---
             else if (targetButton && targetButton.classList.contains('admin-button')) {
                 handleAdminAction(targetButton); // Call the new handler
             }
        }, true); // Use capture phase

        // Handle color input change separately using event delegation
        contentDisplayArea.addEventListener('change', function(event) {
            const target = event.target;
            if (target.matches('.editor-toolbar input[type="color"][data-command="foreColor"]')) {
                formatDoc('foreColor', target.value);
            }
        });


        // --- Initial Setup ---
        // Removed checkAdminMode()
        const updatedContentSections = contentDisplayArea.querySelectorAll('.content-section');
        updatedContentSections.forEach(section => section.classList.remove('visible'));
        if (placeholderContent) placeholderContent.style.display = 'block';
        const initialLang = 'en';
        setLanguage(initialLang, false); // Apply initial translations
        startMatrix();
        updateFullscreenButtonIcon(); // Set initial fullscreen icon state
        // Initialize audio context on first user interaction
        document.body.addEventListener('click', initializeAudio, { once: true });


    </script>

</body>
</html>
